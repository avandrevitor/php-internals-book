

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Basic structure &mdash; PHP Internals Book</title>
    
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="PHP Internals Book" href="../index.html" />
    <link rel="up" title="Zvals" href="../zvals.html" />
    <link rel="next" title="Memory management" href="memory_management.html" />
    <link rel="prev" title="Zvals" href="../zvals.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../index.html">
          <span>PHP Internals Book</span></a></h1>
        <h2 class="heading"><span>Basic structure</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="../zvals.html">Zvals</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="memory_management.html">Memory management</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="basic-structure">
<h1>Basic structure<a class="headerlink" href="#basic-structure" title="Permalink to this headline">¶</a></h1>
<p>A zval (short for &#8220;Zend value&#8221;) represents an arbitrary PHP value. As such it is likely the most important structure in
all of PHP and you&#8217;ll be working with it a lot. This section describes the basic concepts behind zvals and their use.</p>
<div class="section" id="types-and-values">
<h2>Types and values<a class="headerlink" href="#types-and-values" title="Permalink to this headline">¶</a></h2>
<p>Among other things, every zval stores some value and the type this value has. This is necessary because PHP is a
dynamically typed language and as such variable types are only known at run-time and not at compile-time. Furthermore
the type can change during the life of a zval, so if the zval previously stored an integer it may contain a string at a
later point in time.</p>
<p>The type is stored as an integer tag (an unsigned char). It can be one of eight values, which correspond to the eight
types available in PHP. These values are referred to using constants of the form <tt class="docutils literal"><span class="pre">IS_TYPE</span></tt>. E.g. <tt class="docutils literal"><span class="pre">IS_NULL</span></tt>
corresponds to the null type and <tt class="docutils literal"><span class="pre">IS_STRING</span></tt> corresponds to the string type.</p>
<p>The actual value is stored in a union, which is defined as follows:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">union</span> <span class="n">_zvalue_value</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="n">lval</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">dval</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">str</span><span class="p">;</span>
    <span class="n">HashTable</span> <span class="o">*</span><span class="n">ht</span><span class="p">;</span>
    <span class="n">zend_object_value</span> <span class="n">obj</span><span class="p">;</span>
<span class="p">}</span> <span class="n">zvalue_value</span><span class="p">;</span>
</pre></div>
</div>
<p>To those not familiar with the concept of unions: A union defines multiple members of different types, but only one of
them can ever be used at a time. E.g. if the <tt class="docutils literal"><span class="pre">value.lval</span></tt> member was set, then you also need to look up the value
using <tt class="docutils literal"><span class="pre">value.lval</span></tt> and not one of the other members (doing so would violate &#8220;strict aliasing&#8221; guarantees and lead to
undefined behaviour). The reason is that unions store all their members at the same memory location and just interpret
the value located there differently depending on which member you access. The size of the union is the size of its
largest member.</p>
<p>When working with zvals the type tag is used to find out which of the union&#8217;s member is currently in use. Before having
a look at the APIs used to do so, let&#8217;s walk through the different types PHP supports and how they are stored:</p>
<p>The simplest type is <tt class="docutils literal"><span class="pre">IS_NULL</span></tt>: It doesn&#8217;t need to actually store any value, because there is just one <tt class="docutils literal"><span class="pre">null</span></tt> value.</p>
<p>For storing numbers PHP provides the types <tt class="docutils literal"><span class="pre">IS_LONG</span></tt> and <tt class="docutils literal"><span class="pre">IS_DOUBLE</span></tt>, which make use of the <tt class="docutils literal"><span class="pre">long</span> <span class="pre">lval</span></tt> and
<tt class="docutils literal"><span class="pre">double</span> <span class="pre">dval</span></tt> members respectively. The former is used to store integers, whereas the latter stores floating point
numbers.</p>
<p>There are some things that one should be aware of about the <tt class="docutils literal"><span class="pre">long</span></tt> type: Firstly, this is a signed integer type, i.e.
it can store both positive and negative integers, but is commonly not well suited for doing bitwise operations.
Secondly, <tt class="docutils literal"><span class="pre">long</span></tt> has different sizes on different platforms: On 32bit systems it is 32 bits / 4 bytes large, but on
64bit systems it&#8217;s size will be either 4 or 8 bytes. In particular 64bit Unix systems typically have 8 byte longs,
whereas 64bit Windows uses only 4 bytes.</p>
<p>For this reason you shouldn&#8217;t rely on any particular size for the <tt class="docutils literal"><span class="pre">long</span></tt> type. The minimum and maximum values a
<tt class="docutils literal"><span class="pre">long</span></tt> can store are available via <tt class="docutils literal"><span class="pre">LONG_MIN</span></tt> and <tt class="docutils literal"><span class="pre">LONG_MAX</span></tt> and the size of the type can be accessed using
<tt class="docutils literal"><span class="pre">SIZEOF_LONG</span></tt> (unlike <tt class="docutils literal"><span class="pre">sizeof(long)</span></tt> this is also usable in <tt class="docutils literal"><span class="pre">#if</span></tt> directives).</p>
<p>The <tt class="docutils literal"><span class="pre">double</span></tt> type used to store floating point numbers is (typically) an 8-byte value following the IEEE-754
specification. The details of this format won&#8217;t be discussed here, but you should at least be aware of the fact that
this type has limited precision and commonly doesn&#8217;t store the exact value you want.</p>
<p>Booleans use the <tt class="docutils literal"><span class="pre">IS_BOOL</span></tt> flag and are stored in the <tt class="docutils literal"><span class="pre">long</span> <span class="pre">lval</span></tt> member as values 0 (for false) and 1 (for true).
As there are only these two values, one could theoretically use some smaller type instead (like <tt class="docutils literal"><span class="pre">zend_bool</span></tt>, which is
an unsigned char), but as the <tt class="docutils literal"><span class="pre">zvalue_value</span></tt> union has the size of its <em>largest</em> member this would not actually result
in any memory savings. As such the <tt class="docutils literal"><span class="pre">lval</span></tt> member is reused.</p>
<p>Strings (<tt class="docutils literal"><span class="pre">IS_STRING</span></tt>) are stored in <tt class="docutils literal"><span class="pre">struct</span> <span class="pre">{</span> <span class="pre">char</span> <span class="pre">*val;</span> <span class="pre">int</span> <span class="pre">len;</span> <span class="pre">}</span> <span class="pre">str</span></tt>, i.e. they consist of a <tt class="docutils literal"><span class="pre">char*</span></tt> string
and an <tt class="docutils literal"><span class="pre">int</span></tt> length. PHP strings need to store an explicit length in order to allow use of NUL bytes (<tt class="docutils literal"><span class="pre">'\0'</span></tt>) in
them (&#8220;binary safety&#8221;). Regardless of this, the strings used by PHP are still NUL-terminated to ease interoperability
with library functions which don&#8217;t take length arguments and expect NUL-terminated strings instead. Of course in this
case the strings won&#8217;t be binary safe anymore and will be cut off at the first NUL byte they contain. For example many
filesystem related functions behave like this, as well as most libc string functions.</p>
<p>The length of a string is in bytes (not Unicode code points) and does <strong>not</strong> include the terminating NUL byte: The
length of the string <tt class="docutils literal"><span class="pre">&quot;foo&quot;</span></tt> is 3, even though it is actually stored using 4 bytes. If you determine the length of a
constant string using <tt class="docutils literal"><span class="pre">sizeof</span></tt> you need to make sure to subtract one: <tt class="docutils literal"><span class="pre">strlen(&quot;foo&quot;)</span> <span class="pre">==</span> <span class="pre">sizeof(&quot;foo&quot;)</span> <span class="pre">-</span> <span class="pre">1</span></tt></p>
<p>Furthermore it&#8217;s important to realize that the string length is stored in an <tt class="docutils literal"><span class="pre">int</span></tt> and not a <tt class="docutils literal"><span class="pre">long</span></tt> or some other
type. This is an unfortunate historical artifact, which limits the length of strings to 2147483647 bytes. Strings larger
than this would cause an overflow (thus making the length negative).</p>
<p>The remaining three types will only be mentioned here quickly and discussed in greater detail in their own chapters:</p>
<p>Arrays use the <tt class="docutils literal"><span class="pre">IS_ARRAY</span></tt> type tag and are stored in the <tt class="docutils literal"><span class="pre">HashTable</span> <span class="pre">*ht</span></tt> member. How the <tt class="docutils literal"><span class="pre">HashTable</span></tt> structure
works will be discussed in the <a class="reference internal" href="../hashtables.html"><em>Hashtables</em></a> chapter.</p>
<p>Objects (<tt class="docutils literal"><span class="pre">IS_OBJECT</span></tt>) use the <tt class="docutils literal"><span class="pre">zend_object_value</span> <span class="pre">obj</span></tt> member, which consists of an &#8220;object handle&#8221;, which is an
integer ID used to look up the actual data of the object, and a set of &#8220;object handlers&#8221;, which define how the object
behaves. PHP&#8217;s class and object system will be described in the <a class="reference internal" href="../classes_objects.html"><em>Classes and objects</em></a> chapter.</p>
<p>Resources (<tt class="docutils literal"><span class="pre">IS_RESOURCE</span></tt>) are similar to objects in that they also store a unique ID that can be used to look up the
actual value. This ID is stored in the <tt class="docutils literal"><span class="pre">long</span> <span class="pre">lval</span></tt> member. Resources are covered in the Resources chapter (which
doesn&#8217;t exist yet).</p>
<p>To summarize, here&#8217;s a table with all the available type tags and the corresponding storage location for their values:</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type tag</th>
<th class="head">Storage location</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">IS_NULL</span></tt></td>
<td>none</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">IS_BOOL</span></tt></td>
<td><tt class="docutils literal"><span class="pre">long</span> <span class="pre">lval</span></tt></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">IS_LONG</span></tt></td>
<td><tt class="docutils literal"><span class="pre">long</span> <span class="pre">lval</span></tt></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">IS_DOUBLE</span></tt></td>
<td><tt class="docutils literal"><span class="pre">double</span> <span class="pre">dval</span></tt></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">IS_STRING</span></tt></td>
<td><tt class="docutils literal"><span class="pre">struct</span> <span class="pre">{</span> <span class="pre">char</span> <span class="pre">*val;</span> <span class="pre">int</span> <span class="pre">len;</span> <span class="pre">}</span> <span class="pre">str</span></tt></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">IS_ARRAY</span></tt></td>
<td><tt class="docutils literal"><span class="pre">HashTable</span> <span class="pre">*ht</span></tt></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">IS_OBJECT</span></tt></td>
<td><tt class="docutils literal"><span class="pre">zend_object_value</span> <span class="pre">obj</span></tt></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">IS_RESOURCE</span></tt></td>
<td><tt class="docutils literal"><span class="pre">long</span> <span class="pre">lval</span></tt></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="access-macros">
<h2>Access macros<a class="headerlink" href="#access-macros" title="Permalink to this headline">¶</a></h2>
<p>Lets now have a look at how the <tt class="docutils literal"><span class="pre">zval</span></tt> struct actually looks like:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_zval_struct</span> <span class="p">{</span>
    <span class="n">zvalue_value</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">zend_uint</span> <span class="n">refcount__gc</span><span class="p">;</span>
    <span class="n">zend_uchar</span> <span class="n">type</span><span class="p">;</span>
    <span class="n">zend_uchar</span> <span class="n">is_ref__gc</span><span class="p">;</span>
<span class="p">}</span> <span class="n">zval</span><span class="p">;</span>
</pre></div>
</div>
<p>As already mentioned, the zval has members to store a <tt class="docutils literal"><span class="pre">value</span></tt> and its <tt class="docutils literal"><span class="pre">type</span></tt>. The value is stored in the
<tt class="docutils literal"><span class="pre">zvalue_value</span></tt> union discussed above and the type tag is held in a <tt class="docutils literal"><span class="pre">zend_uchar</span></tt>. Additionally the structure has two
properties ending in <tt class="docutils literal"><span class="pre">__gc</span></tt>, which are used for the garbage collection mechanism PHP employs. We&#8217;ll ignore them for
now and discuss their function in the next section.</p>
<p>Knowing the zval structure you can now write code making use of it:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">zval</span> <span class="o">*</span><span class="n">zv_ptr</span> <span class="o">=</span> <span class="cm">/* ... get zval from somewhere */</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">zv_ptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IS_LONG</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;Zval is a long with value %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">zv_ptr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">lval</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="cm">/* ... handle other types */</span>
</pre></div>
</div>
<p>While the above code works, this is not the idiomatic way to write it. It directly accesses the zval members rather than
using a special set of access macros for this purpose:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">zval</span> <span class="o">*</span><span class="n">zv_ptr</span> <span class="o">=</span> <span class="cm">/* ... */</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">Z_TYPE_P</span><span class="p">(</span><span class="n">zv_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">IS_LONG</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;Zval is a long with value %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Z_LVAL_P</span><span class="p">(</span><span class="n">zv_ptr</span><span class="p">));</span>
<span class="p">}</span> <span class="k">else</span> <span class="cm">/* ... */</span>
</pre></div>
</div>
<p>The above code uses the <tt class="docutils literal"><span class="pre">Z_TYPE_P()</span></tt> macro for retrieving the type tag and <tt class="docutils literal"><span class="pre">Z_LVAL_P()</span></tt> to get the long (integer)
value. All the access macros have variants with a <tt class="docutils literal"><span class="pre">_P</span></tt> suffix, a <tt class="docutils literal"><span class="pre">_PP</span></tt> suffix or no suffix at all. Which one you
use depends on whether you are working on a <tt class="docutils literal"><span class="pre">zval</span></tt>, a <tt class="docutils literal"><span class="pre">zval*</span></tt> or a <tt class="docutils literal"><span class="pre">zval**</span></tt>:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">zval</span> <span class="n">zv</span><span class="p">;</span>
<span class="n">zval</span> <span class="o">*</span><span class="n">zv_ptr</span><span class="p">;</span>
<span class="n">zval</span> <span class="o">**</span><span class="n">zv_ptr_ptr</span><span class="p">;</span>
<span class="n">zval</span> <span class="o">***</span><span class="n">zv_ptr_ptr_ptr</span><span class="p">;</span>

<span class="n">Z_TYPE</span><span class="p">(</span><span class="n">zv</span><span class="p">);</span>                 <span class="c1">// = zv.type</span>
<span class="n">Z_TYPE_P</span><span class="p">(</span><span class="n">zv_ptr</span><span class="p">);</span>           <span class="c1">// = zv_ptr-&gt;type</span>
<span class="n">Z_TYPE_PP</span><span class="p">(</span><span class="n">zv_ptr_ptr</span><span class="p">);</span>      <span class="c1">// = (*zv_ptr_ptr)-&gt;type</span>
<span class="n">Z_TYPE_PP</span><span class="p">(</span><span class="o">*</span><span class="n">zv_ptr_ptr_ptr</span><span class="p">);</span> <span class="c1">// = (**zv_ptr_ptr_ptr)-&gt;type</span>
</pre></div>
</div>
<p>Basically the number of <tt class="docutils literal"><span class="pre">P</span></tt>s should be the same as the number of <tt class="docutils literal"><span class="pre">*</span></tt>s of the type. This only works until
<tt class="docutils literal"><span class="pre">zval**</span></tt>, i.e. there are no special macros for working with <tt class="docutils literal"><span class="pre">zval***</span></tt> as this is rarely necessary in practice
(you&#8217;ll just have to dereference the value first using the <tt class="docutils literal"><span class="pre">*</span></tt> operator).</p>
<p>Similarly to <tt class="docutils literal"><span class="pre">Z_LVAL</span></tt> there are also macros for fetching values of all the other types. To demonstrate their usage
we&#8217;ll create a simple function for dumping a zval:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">dump</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">zval</span> <span class="o">*</span><span class="n">zv_ptr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">zend_parse_parameters</span><span class="p">(</span><span class="n">ZEND_NUM_ARGS</span><span class="p">()</span> <span class="n">TSRMLS_CC</span><span class="p">,</span> <span class="s">&quot;z&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zv_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">FAILURE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">Z_TYPE_P</span><span class="p">(</span><span class="n">zv_ptr</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">IS_NULL</span>:
            <span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;NULL: null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">IS_BOOL</span>:
            <span class="k">if</span> <span class="p">(</span><span class="n">Z_BVAL_P</span><span class="p">(</span><span class="n">zv_ptr</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;BOOL: true</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;BOOL: false</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">IS_LONG</span>:
            <span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;LONG: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Z_LVAL_P</span><span class="p">(</span><span class="n">zv_ptr</span><span class="p">));</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">IS_DOUBLE</span>:
            <span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;DOUBLE: %g</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Z_DVAL_P</span><span class="p">(</span><span class="n">zv_ptr</span><span class="p">));</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">IS_STRING</span>:
            <span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;STRING: value=</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">PHPWRITE</span><span class="p">(</span><span class="n">Z_STRVAL_P</span><span class="p">(</span><span class="n">zv_ptr</span><span class="p">),</span> <span class="n">Z_STRLEN_P</span><span class="p">(</span><span class="n">zv_ptr</span><span class="p">));</span>
            <span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">, length=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Z_STRLEN_P</span><span class="p">(</span><span class="n">zv_ptr</span><span class="p">));</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">IS_RESOURCE</span>:
            <span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;RESOURCE: id=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Z_RESVAL_P</span><span class="p">(</span><span class="n">zv_ptr</span><span class="p">));</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">IS_ARRAY</span>:
            <span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;ARRAY: hashtable=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Z_ARRVAL_P</span><span class="p">(</span><span class="n">zv_ptr</span><span class="p">));</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">IS_OBJECT</span>:
            <span class="n">php_printf</span><span class="p">(</span><span class="s">&quot;OBJECT: ???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">zend_function_entry</span> <span class="n">funcs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PHP_FE</span><span class="p">(</span><span class="n">dump</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="n">PHP_FE_END</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Lets try it out:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">dump</span><span class="p">(</span><span class="n">null</span><span class="p">);</span>                 <span class="c1">// NULL: null</span>
<span class="n">dump</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>                 <span class="c1">// BOOL: true</span>
<span class="n">dump</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>                <span class="c1">// BOOL: false</span>
<span class="n">dump</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>                   <span class="c1">// LONG: 42</span>
<span class="n">dump</span><span class="p">(</span><span class="mf">4.2</span><span class="p">);</span>                  <span class="c1">// DOUBLE: 4.2</span>
<span class="n">dump</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span>                <span class="c1">// STRING: value=&quot;foo&quot;, length=3</span>
<span class="n">dump</span><span class="p">(</span><span class="n">fopen</span><span class="p">(</span><span class="n">__FILE__</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">));</span> <span class="c1">// RESOURCE: id=???</span>
<span class="n">dump</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>       <span class="c1">// ARRAY: hashtable=0x???</span>
<span class="n">dump</span><span class="p">(</span><span class="n">new</span> <span class="n">stdClass</span><span class="p">);</span>         <span class="c1">// OBJECT: ???</span>
</pre></div>
</div>
<p>The macros for accessing the values are pretty straightforward: <tt class="docutils literal"><span class="pre">Z_BVAL</span></tt> for bools, <tt class="docutils literal"><span class="pre">Z_LVAL</span></tt> for longs, <tt class="docutils literal"><span class="pre">Z_DVAL</span></tt>
for doubles. For strings <tt class="docutils literal"><span class="pre">Z_STRVAL</span></tt> returns the actual <tt class="docutils literal"><span class="pre">char*</span></tt> string, whereas <tt class="docutils literal"><span class="pre">Z_STRLEN</span></tt> provides us with the
length. The resource ID can be fetched using <tt class="docutils literal"><span class="pre">Z_RESVAL</span></tt> and the <tt class="docutils literal"><span class="pre">HashTable*</span></tt> of an array is accessed with
<tt class="docutils literal"><span class="pre">Z_ARRVAL</span></tt>. How object values are accessed will not be covered here as it requires some more background knowledge.</p>
<p>When you want to access the contents of a zval you should always go through these macros, rather than directly accessing
its members. This maintains a level of abstraction and makes the intention clearer: For example, if you directly
accessed the <tt class="docutils literal"><span class="pre">lval</span></tt> member you could either be fetching the bool value, the long value or the resource ID. Using
<tt class="docutils literal"><span class="pre">Z_BVAL</span></tt>, <tt class="docutils literal"><span class="pre">Z_LVAL</span></tt> and <tt class="docutils literal"><span class="pre">Z_RESVAL</span></tt> instead makes the intention unambiguous. Using the macros also serves as a
protection against changes to the internal zval representation in future PHP versions.</p>
</div>
<div class="section" id="setting-the-value">
<h2>Setting the value<a class="headerlink" href="#setting-the-value" title="Permalink to this headline">¶</a></h2>
<p>Most of the macros introduced above just access some member of the zval structure and as such you can use them both to
read and to write the respective values. As an example consider the following function, which simply returns the string
&#8220;hello world!&#8221;:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">hello_world</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Z_TYPE_P</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span> <span class="o">=</span> <span class="n">IS_STRING</span><span class="p">;</span>
    <span class="n">Z_STRVAL_P</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span> <span class="o">=</span> <span class="n">estrdup</span><span class="p">(</span><span class="s">&quot;hello world!&quot;</span><span class="p">);</span>
    <span class="n">Z_STRLEN_P</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;hello world!&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/* ... */</span>
    <span class="n">PHP_FE</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="cm">/* ... */</span>
</pre></div>
</div>
<p>Running <tt class="docutils literal"><span class="pre">php</span> <span class="pre">-r</span> <span class="pre">&quot;echo</span> <span class="pre">hello_world();&quot;</span></tt> should now print <tt class="docutils literal"><span class="pre">hello</span> <span class="pre">world!</span></tt> to the terminal.</p>
<p>In the above example we set the <tt class="docutils literal"><span class="pre">return_value</span></tt> variable, which is a <tt class="docutils literal"><span class="pre">zval*</span></tt> provided by the <tt class="docutils literal"><span class="pre">PHP_FUNCTION</span></tt> macro.
We&#8217;ll look at this variable in more detail in the next chapter, for now it should suffice to know that the value of this
variable will be the return value of the function. By default it is initialized to have type <tt class="docutils literal"><span class="pre">IS_NULL</span></tt>.</p>
<p>Setting a zval value using the access macros is really straightforward, but there are some things one should keep in
mind: First of all you need to remember that the type tag determines the type of a zval. It doesn&#8217;t suffice to just set
the value (via <tt class="docutils literal"><span class="pre">Z_STRVAL</span></tt> and <tt class="docutils literal"><span class="pre">Z_STRLEN</span></tt> here), you always need to set the type tag as well.</p>
<p>Furthermore you need to be aware of the fact that in most cases the zval &#8220;owns&#8221; its value and that the zval will have a
longer life-time than the scope in which you set its value. Sometimes this doesn&#8217;t apply when dealing with temporary
zvals, but in most cases it&#8217;s true.</p>
<p>Using the above example this means that the <tt class="docutils literal"><span class="pre">return_value</span></tt> will live on after our function body leaves (which is quite
obvious, otherwise nobody could use the return value), so it can&#8217;t make use of any temporary values of the function.
E.g. just writing <tt class="docutils literal"><span class="pre">Z_STRVAL_P(return_value)</span> <span class="pre">=</span> <span class="pre">&quot;hello</span> <span class="pre">world!&quot;</span></tt> would be invalid, because the string literal
<tt class="docutils literal"><span class="pre">&quot;hello</span> <span class="pre">world!&quot;</span></tt> ceases to exist after the body is left (which is true for every stack allocated value in C).</p>
<p>Because of this we need to copy the string using <tt class="docutils literal"><span class="pre">estrdup()</span></tt>. This will create a separate copy of the string on the
heap. Because the zval &#8220;owns&#8221; its value, it will make sure to free this copy when the zval is destroyed. This also
applies to any other &#8220;complex&#8221; value of the zval. E.g. if you set the <tt class="docutils literal"><span class="pre">HashTable*</span></tt> for an array, the zval will take
ownership of it and free it when the zval is destroyed. When using primitive types like integers or doubles you
obviously don&#8217;t need to care about this, as they are always copied.</p>
<p>Lastly, it should be pointed out that not all of the access macros directly return a member. The <tt class="docutils literal"><span class="pre">Z_BVAL</span></tt> macro for
example is defined as follows:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define Z_BVAL(zval) ((zend_bool)(zval).value.lval)</span>
</pre></div>
</div>
<p>Because this macro contains a cast you will not be able to write <tt class="docutils literal"><span class="pre">Z_BVAL_P(return_value)</span> <span class="pre">=</span> <span class="pre">1</span></tt>. Apart from some of the
object-related macros this is the only exception though. All the other access macros can be used to set values.</p>
<p>In practice you won&#8217;t have to worry about the last bit though: As setting the zval value is such a common task, PHP
provides another set of macros for this purpose. They allow you to set the type tag and the value at the same time.
Rewriting the previous example using such a macro yields:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">hello_world</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ZVAL_STRINGL</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">estrdup</span><span class="p">(</span><span class="s">&quot;hello world!&quot;</span><span class="p">),</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;hello world!&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As it is very common that the string has to be copied when assigning to the zval, the last (boolean) parameter of the
<tt class="docutils literal"><span class="pre">ZVAL_STRINGL</span></tt> macro can handle this for you. If you pass <tt class="docutils literal"><span class="pre">0</span></tt> the string is used as is, but if you pass <tt class="docutils literal"><span class="pre">1</span></tt> it
will be copied using <tt class="docutils literal"><span class="pre">estrndup()</span></tt>. Thus our example can be rewritten as:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">hello_world</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ZVAL_STRINGL</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="s">&quot;hello world!&quot;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;hello world!&quot;</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Furthermore we don&#8217;t need to manually compute the <tt class="docutils literal"><span class="pre">strlen</span></tt> and can use the <tt class="docutils literal"><span class="pre">ZVAL_STRING</span></tt> macro (without the <tt class="docutils literal"><span class="pre">L</span></tt> at
the end) instead:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">PHP_FUNCTION</span><span class="p">(</span><span class="n">hello_world</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ZVAL_STRING</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="s">&quot;hello world!&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you know the length of the string (because it was passed to you in some way) you should always make use of it via the
<tt class="docutils literal"><span class="pre">ZVAL_STRINGL</span></tt> macro in order to preserve binary-safety. If you don&#8217;t know the length (or know that the string doesn&#8217;t
contain NUL bytes, as is usually the case with literals) you can use <tt class="docutils literal"><span class="pre">ZVAL_STRING</span></tt> instead.</p>
<p>Apart from <tt class="docutils literal"><span class="pre">ZVAL_STRING(L)</span></tt> there are a few more macros for setting values, which are listed in the following
example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">ZVAL_NULL</span><span class="p">(</span><span class="n">return_value</span><span class="p">);</span>

<span class="n">ZVAL_BOOL</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">ZVAL_BOOL</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cm">/* or better */</span>
<span class="n">ZVAL_FALSE</span><span class="p">(</span><span class="n">return_value</span><span class="p">);</span>
<span class="n">ZVAL_TRUE</span><span class="p">(</span><span class="n">return_value</span><span class="p">);</span>

<span class="n">ZVAL_LONG</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="mi">42</span><span class="p">);</span>
<span class="n">ZVAL_DOUBLE</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="mf">4.2</span><span class="p">);</span>
<span class="n">ZVAL_RESOURCE</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">);</span>

<span class="n">ZVAL_EMPTY_STRING</span><span class="p">(</span><span class="n">return_value</span><span class="p">);</span>
<span class="cm">/* = ZVAL_STRING(return_value, &quot;&quot;, 1); */</span>

<span class="n">ZVAL_STRING</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cm">/* = ZVAL_STRING(return_value, estrdup(&quot;string&quot;), 0); */</span>

<span class="n">ZVAL_STRINGL</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="s">&quot;nul</span><span class="se">\0</span><span class="s">string&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cm">/* = ZVAL_STRINGL(return_value, estrndup(&quot;nul\0string&quot;, 10), 10, 0); */</span>
</pre></div>
</div>
<p>Note that these macros will set the value, but not destroy any value that the zval might have previously held. For the
<tt class="docutils literal"><span class="pre">return_value</span></tt> zval this doesn&#8217;t matter because it was initialized to <tt class="docutils literal"><span class="pre">IS_NULL</span></tt> (which has no value that needs to be
freed), but in other cases you&#8217;ll have to destroy the old value first using the functions described in the following
section.</p>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="../zvals.html">Zvals</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="memory_management.html">Memory management</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer feedback">
        Send feedback to <a href="mailto:feedback@phpinternalsbook.com">feedback@phpinternalsbook.com</a>
    </div>
    
    <div class="footer">
        &copy; Copyright 2013, Julien Pauli - Anthony Ferrara - Nikita Popov.
    </div>
    <div class="footer feedback">
        All Rights Reserved
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-41617167-1', 'phpinternalsbook.com');
      ga('send', 'pageview');
    </script>

  </body>
</html>